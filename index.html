<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Competencia (Pro)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React + Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <style>
        body { 
            background-color: #0a0a0a; 
            color: white; 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 10px; }
        
        .loader-container { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: #000; z-index: 9999; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-left-color: #ec4899; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-out { opacity: 0; pointer-events: none; }
        
        .glass-panel {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* --- ESTILOS BIBLIOTECA RESPONSIVA --- */
        .shelf-container {
            display: grid;
            gap: 20px;
            padding: 40px 20px;
            perspective: 1200px;
            max-width: 1800px; 
            margin: 0 auto;
            align-items: end;
            /* Default móvil: se ajusta al ancho */
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        }

        /* Escritorio: Forzamos 5 columnas para el look de biblioteca */
        @media (min-width: 1024px) {
            .shelf-container {
                grid-template-columns: repeat(5, 1fr); 
            }
        }

        .book-spine {
            width: 100%; 
            min-width: 0; /* Fix flexbox overflow */
            height: 450px; 
            border-radius: 16px;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            box-shadow: -5px 0 15px rgba(0,0,0,0.6) inset, 5px 5px 15px rgba(0,0,0,0.4);
            z-index: 1;
            overflow: hidden;
            background-color: #1a1a1a; /* Fallback color */
        }

        /* Solo rotamos en escritorio para el efecto 3D */
        @media (min-width: 1024px) {
            .book-spine { transform: rotateY(-5deg); }
            
            .book-spine:hover {
                width: 360px; 
                position: relative; 
                min-width: 360px; 
                margin-left: -80px; 
                margin-right: -80px;
                z-index: 100;
                transform: translateY(-30px) scale(1.05) rotateY(0deg);
                box-shadow: 0 40px 80px rgba(0,0,0,0.9);
                border-radius: 24px;
            }
        }
        
        /* En móvil, efecto simple de elevación */
        @media (max-width: 1023px) {
            .book-spine { height: 320px; transform: none; }
            .book-spine:active { transform: scale(0.98); }
        }

        .spine-content {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 30px 10px;
            transition: opacity 0.3s;
            opacity: 1;
        }

        .cover-content {
            position: absolute;
            inset: 0;
            opacity: 0;
            transition: opacity 0.4s 0.2s;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background: linear-gradient(to bottom, rgba(20,20,20,0.85), rgba(0,0,0,0.9));
        }

        /* En escritorio, mostramos tapa solo en hover */
        @media (min-width: 1024px) {
            .book-spine:hover .spine-content { opacity: 0; pointer-events: none; }
            .book-spine:hover .cover-content { opacity: 1; }
            
            .spine-title {
                writing-mode: vertical-rl;
                text-orientation: mixed;
                transform: rotate(180deg);
                white-space: nowrap;
                font-weight: 900;
                letter-spacing: 3px;
                text-transform: uppercase;
                font-size: 20px; 
                opacity: 0.9;
                text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            }
        }

        /* En móvil, mostramos la tapa siempre (estilo tarjeta) */
        @media (max-width: 1023px) {
            .spine-content { display: none; }
            .cover-content { opacity: 1; }
        }

        /* Marca de agua */
        .watermark-logo {
            position: absolute;
            bottom: -20px;
            right: -20px;
            width: 180px;
            height: 180px;
            opacity: 0.15;
            pointer-events: none;
            filter: grayscale(100%);
            transform: rotate(-15deg);
            z-index: 0;
        }

        @keyframes magic-pulse { 0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); } 100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); } }
        .magic-btn:hover { animation: magic-pulse 1s infinite; }
    </style>
</head>
<body>

    <div id="loader" class="loader-container">
        <div class="text-center">
            <div class="spinner mb-4 mx-auto"></div>
            <p class="text-white/40 text-xs tracking-[0.3em] uppercase font-bold">Conectando...</p>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            TrendingUp, School, GraduationCap, CalendarClock, Database, Wifi, 
            WifiOff, Plus, Save, X, DollarSign, CreditCard, Eye, MessageCircleHeart, 
            FileSignature, MapPin, Phone, Percent, Calculator, ThumbsUp, ThumbsDown, 
            Pencil, User, Clock, Trash2, CloudOff, Layers, Users, AlertTriangle, Sparkles, Download, Palette, RefreshCw, Award, Copy, Tag, Scale, Library, Filter, Image as ImageIcon
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, doc, setDoc, onSnapshot } from 'firebase/firestore';

        const firebaseConfig = {
            apiKey: "AIzaSyAUhd2TlP1-RLnfXFPhZUcGGC1mJ4IBMWw",
            authDomain: "monitorcompetencia.firebaseapp.com",
            projectId: "monitorcompetencia",
            storageBucket: "monitorcompetencia.firebasestorage.app",
            messagingSenderId: "302198704198",
            appId: "1:302198704198:web:6ed2d4df49ebdec0fea247",
            measurementId: "G-QN3FERMGT0"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Firebase Init Error", e); }

        setTimeout(() => {
            const loader = document.getElementById('loader');
            if(loader) loader.classList.add('fade-out');
        }, 1500);

        const getDominantColor = (imageSrc) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = imageSrc;
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 1;
                        canvas.height = 1;
                        ctx.drawImage(img, 0, 0, 1, 1);
                        const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
                        resolve(`rgb(${r},${g},${b})`);
                    } catch (e) { resolve(null); }
                };
                img.onerror = () => resolve(null);
            });
        };

        // --- HELPERS ---
        const formatCurrency = (value) => {
            if (!value) return '';
            const num = value.toString().replace(/[^\d]/g, '');
            return num.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        const parseCurrency = (value) => {
            if (!value) return 0;
            return parseFloat(value.toString().replace(/\./g, '')) || 0;
        };

        // --- BASE DE DATOS ---
        const INSTITUTIONS_DB = [
            { name: "Cervantes", color: "#1d4ed8", logo: "https://i.postimg.cc/1XVj0682/Cervantes.png" },
            { name: "Santo Domingo", color: "#0d9488", logo: "https://i.postimg.cc/8fHH5TZg/Santo-Domingo.png" }, 
            { name: "IES", color: "#38bdf8", logo: "https://i.postimg.cc/brSB0bGz/IES.png" }, 
            { name: "Siglo 21", color: "#14532d", logo: "https://i.postimg.cc/hQrrjK2q/Siglo-21.png" }, 
            { name: "CEBA", color: "#be185d", logo: "https://i.postimg.cc/PJvRbZC7/Ceba.png" }, 
            { name: "Saber", color: "#1d4ed8", logo: "https://i.postimg.cc/F1tnTRcK/Saber.png" }, 
            { name: "BAC", color: "#78350f", logo: "https://i.postimg.cc/SRYvL8nH/BAC_Spinoza.png" }, 
            { name: "I. Superior Pascal", color: "#7f1d1d", logo: "https://i.postimg.cc/hvQ58xJD/IS_Pascal.png" }, 
            { name: "Undef", color: "#0284c7", logo: "https://i.postimg.cc/n9kkzn3r/UNDEF.png" }, 
            { name: "Teclab", color: "#60a5fa", logo: "https://i.postimg.cc/jnXX5RMT/Tec-Lab.png" }, 
            { name: "Aeronáutico", color: "#eab308", logo: "https://i.postimg.cc/mD5nFVgv/Aeronautico.png" }, 
            { name: "Fasta", color: "#1e3a8a", logo: "https://i.postimg.cc/90wnPT42/Fasta.png" }, 
            { name: "UTN", color: "#4b5563", logo: "https://i.postimg.cc/jnXX5RMw/UTN.png" }, 
            { name: "Iscet", color: "#f97316", logo: "https://i.postimg.cc/8cf0dWF5/ISCET.png" }, 
            { name: "Kennedy", color: "#881337", logo: "https://i.postimg.cc/1VPBs8rS/Kennedy.png" }, 
            { name: "CUP", color: "#ea580c", logo: "https://i.postimg.cc/R3B2NZRh/CUP.png" }, 
            { name: "Católica", color: "#1e40af", logo: "https://i.postimg.cc/NKTWsH1L/Catolica.png" }
        ];

        const CAREER_OPTIONS = [
            "Higiene y Seguridad", "Marketing", "Administración de Empresas", "Recursos Humanos",
            "Gestión Inmobiliaria", "Analista de Sistemas", "Ciencia de Datos e Inteligencia artificial",
            "Desarrollo Web y Aplicaciones Digitales"
        ];

        const EMPTY_CAREER = {
            id: null, carrera: '', matricula: '', cuota: '', cantidadCuotas: '', valorSemestre: '', 
            duracion: '', titulo: '', promocion: '', mediosPago: '', atencion: '', observacion: '', 
            modalidad: '', destacadoPositivo: '', destacadoNegativo: ''
        };

        function CompetitorApp() {
            const [user, setUser] = useState(null);
            const [competitorData, setCompetitorData] = useState({});
            const [demoMode, setDemoMode] = useState(false);
            const [connectionError, setConnectionError] = useState(null);
            
            const [selectedInst, setSelectedInst] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [isAddingNew, setIsAddingNew] = useState(false);
            const [compareMode, setCompareMode] = useState(null);

            const [dynamicColors, setDynamicColors] = useState({});
            const [currentCareerIndex, setCurrentCareerIndex] = useState(0);
            const [showMagicPaste, setShowMagicPaste] = useState(false);
            const [magicText, setMagicText] = useState("");
            const [lastUser, setLastUser] = useState("");
            const [isCustomCareer, setIsCustomCareer] = useState(false);
            const [customColor, setCustomColor] = useState(null);
            const [filterCareer, setFilterCareer] = useState(""); 

            // Estado para edición de nombre/logo de la institución actual
            const [formData, setFormData] = useState({
                name: '', logo: '', // Nuevos campos editables de institución
                direccion: '', contacto: '', responsable: '', customFields: [], careers: [] 
            });

            const [newInstData, setNewInstData] = useState({ name: '', logo: '', color: '#ec4899' });

            // Auth & Data
            useEffect(() => {
                if (!auth) { setDemoMode(true); setConnectionError("Error Inicialización"); return; }
                const unsub = onAuthStateChanged(auth, (u) => { if(u) { setUser(u); if(!demoMode) setConnectionError(null); } });
                signInAnonymously(auth).catch((e) => {
                    console.warn("Auth error", e); setDemoMode(true);
                    if (e.code !== 'auth/operation-not-allowed') setConnectionError(`Error: ${e.message}`);
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (demoMode) {
                    const saved = localStorage.getItem('competitor_data_shared');
                    if (saved) setCompetitorData(JSON.parse(saved));
                    return;
                }
                if (!db) return;
                try {
                    const q = collection(db, 'base_datos_compartida');
                    const unsub = onSnapshot(q, (snap) => {
                        const d = {};
                        snap.forEach((doc) => d[doc.id] = doc.data());
                        setCompetitorData(d);
                        setDemoMode(false);
                        setConnectionError(null);
                    }, (err) => {
                        console.warn("Firestore error", err);
                        setDemoMode(true);
                    });
                    return () => unsub();
                } catch(e) { setDemoMode(true); }
            }, [user, demoMode]);

            // Colores
            useEffect(() => {
                const run = async () => {
                    const cols = {};
                    for (const inst of INSTITUTIONS_DB) {
                        const savedColor = competitorData[inst.name]?.customColor;
                        if (savedColor) cols[inst.name] = savedColor;
                        else if (inst.logo && !dynamicColors[inst.name]) {
                            const c = await getDominantColor(inst.logo);
                            if (c) cols[inst.name] = c;
                        }
                    }
                    setDynamicColors(p => ({...p, ...cols}));
                };
                run();
            }, [competitorData]);

            const mergedInstitutions = useMemo(() => {
                const list = [...INSTITUTIONS_DB];
                Object.keys(competitorData).forEach(k => {
                    if (!list.find(i => i.name === k)) list.push({ name: k, color: competitorData[k].customColor || '#555', logo: competitorData[k].customLogo, isCustom: true });
                });
                return list;
            }, [competitorData]);

            const displayedInstitutions = useMemo(() => {
                if (!filterCareer) return mergedInstitutions;
                return mergedInstitutions.filter(inst => {
                    const data = competitorData[inst.name];
                    if (!data || !data.careers) return false;
                    return data.careers.some(c => c.carrera && c.carrera.includes(filterCareer));
                });
            }, [mergedInstitutions, competitorData, filterCareer]);

            const exportExcel = () => {
                const cervantesData = competitorData['Cervantes'];
                const cervantesMap = {};
                if (cervantesData?.careers) cervantesData.careers.forEach(c => { 
                    const names = c.carrera ? c.carrera.split(',').map(n => n.trim().toLowerCase()) : [];
                    names.forEach(n => cervantesMap[n] = c);
                });
                const defaultBaseline = cervantesData?.careers?.[0] || null;

                const getVal = (c) => {
                    if (!c) return 0;
                    const vSem = parseCurrency(c.valorSemestre);
                    if (vSem > 0) return vSem;
                    const vCuota = parseCurrency(c.cuota);
                    const vCant = parseFloat(c.cantidadCuotas) || 0;
                    const vMatr = parseCurrency(c.matricula);
                    if (vCuota > 0 && vCant > 0) return (vCuota * vCant) + vMatr;
                    return 0;
                };

                const rows = [['Institución', 'Carrera', 'Duración', 'Título', 'Modalidad', 'Matrícula ($)', 'Cuota ($)', 'Cant. Cuotas', 'Semestre ($)', 'Comparación vs Cervantes', 'Responsable']];

                const listToExport = filterCareer ? displayedInstitutions : mergedInstitutions;
                listToExport.forEach(inst => {
                    const data = competitorData[inst.name];
                    if (!data) return;
                    const careers = data.careers && data.careers.length > 0 ? data.careers : [data];

                    careers.forEach(career => {
                        if (!career.carrera && !career.matricula) return;
                        const semVal = getVal(career);
                        let compText = "-", style = "";
                        
                        let baseline = null;
                        const careerNames = career.carrera ? career.carrera.split(',').map(n => n.trim().toLowerCase()) : [];
                        for(let name of careerNames) { if(cervantesMap[name]) { baseline = cervantesMap[name]; break; } }
                        if (!baseline) baseline = defaultBaseline;

                        if (inst.name !== 'Cervantes' && baseline) {
                            const baseVal = getVal(baseline);
                            if (baseVal > 0 && semVal > 0) {
                                if (semVal > baseVal) { compText = "Más CARO que Cervantes"; style = "background-color:#C6EFCE; color:#006100;"; }
                                else if (semVal < baseVal) { compText = "Más BARATO que Cervantes"; style = "background-color:#FFC7CE; color:#9C0006;"; }
                                else compText = "Igual que Cervantes";
                            }
                        }
                        rows.push({
                            cells: [ inst.name, career.carrera || '-', career.duracion || '-', career.titulo || '-', career.modalidad || '-', career.matricula || '-', career.cuota || '-', career.cantidadCuotas || '-', formatCurrency(semVal) || '-', compText, data.responsable || '-' ],
                            style
                        });
                    });
                });

                let table = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Competencia</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta charset="UTF-8"></head><body><table border="1"><thead><tr style="background-color:#444;color:white;">${rows[0].map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${rows.slice(1).map(r=>`<tr>${r.cells.map((c,i)=>{const s=(i===9&&r.style)?` style="${r.style}"`:'';return `<td${s}>${c}</td>`}).join('')}</tr>`).join('')}</tbody></table></body></html>`;
                const url = window.URL.createObjectURL(new Blob([table], {type:'application/vnd.ms-excel'}));
                const a = document.createElement('a'); a.href=url; a.download=`Competencia_${new Date().toISOString().split('T')[0]}.xls`; a.click();
            };

            const handleMagicPaste = () => {
                if (!magicText.trim()) return;
                const text = magicText;
                const lines = text.split(/\n+/);
                const newValues = {};
                let fullTextLower = text.toLowerCase();

                if (fullTextLower.includes('online')) newValues.modalidad = '100% Online';
                else if (fullTextLower.includes('hibrid')) newValues.modalidad = 'Híbrida';
                else if (fullTextLower.includes('presencial')) newValues.modalidad = 'Presencial';
                
                const promo = text.match(/(\d+%\s?(off|descuento)|bonificaci[óo]n.*)/i);
                if (promo) newValues.promocion = promo[0];
                if (text.includes('tarjeta') || text.includes('transferencia')) newValues.mediosPago = "Transferencia / Tarjeta / Efectivo";

                lines.forEach(line => {
                    const l = line.toLowerCase();
                    // Buscar montos de dinero
                    const priceMatch = l.match(/(?:\$|u\$s)?\s?([1-9]\d{0,2}(?:\.\d{3})*)/);
                    // Buscar cantidad de cuotas (números chicos 1-12 seguidos de "cuota")
                    const quotaMatch = l.match(/(\d{1,2})\s*(?:cuotas|pagos|meses)/);

                    if (quotaMatch && !newValues.cantidadCuotas) {
                        const q = parseInt(quotaMatch[1]);
                        if (q < 50) newValues.cantidadCuotas = q.toString();
                    }

                    if (priceMatch) {
                        const rawNum = priceMatch[1].replace(/\./g, '');
                        if(rawNum.length === 4 && (rawNum.startsWith('202'))) return; 
                        const val = formatCurrency(rawNum);

                        if (l.includes('matr') || l.includes('inscrip')) newValues.matricula = val;
                        else if (l.includes('semestre') && (l.includes('completo') || l.includes('valor'))) newValues.valorSemestre = val;
                        else if ((l.includes('cuota') || l.includes('mes') || l.includes('mensual')) && !newValues.cuota) {
                            newValues.cuota = val;
                        }
                    }
                });

                if (!newValues.observacion && magicText.length > 20) newValues.observacion = "Info pegada: " + magicText.substring(0,150) + "...";

                const newCareers = [...formData.careers];
                newCareers[currentCareerIndex] = { ...newCareers[currentCareerIndex], ...newValues };
                setFormData({ ...formData, careers: newCareers });
                setMagicText("");
                setShowMagicPaste(false);
            };

            const handleCardClick = (inst) => {
                const d = competitorData[inst.name] || {};
                const savedColor = d.customColor || dynamicColors[inst.name] || inst.color || '#ec4899';
                setCustomColor(savedColor);

                let careersList = (d.careers && d.careers.length > 0) ? d.careers : (d.carrera || d.matricula ? [{...EMPTY_CAREER, id:Date.now(), ...d}] : [{...EMPTY_CAREER, id:Date.now()}]);
                const savedUser = d.responsable || lastUser || '';
                
                setFormData({
                    // Precargar campos editables de la institución
                    name: d.customName || inst.name,
                    logo: d.customLogo || inst.logo || '',
                    
                    direccion: d.direccion || '', contacto: d.contacto || '', responsable: savedUser,
                    customFields: d.customFields || [], careers: careersList
                });
                setCurrentCareerIndex(0);
                setSelectedInst(inst);
                setIsEditing(false);
                setIsCustomCareer(false);
            };

            const handleDuplicateCareer = (e, index) => {
                e.stopPropagation();
                const careerToCopy = formData.careers[index];
                const newCareer = { ...careerToCopy, id: Date.now() };
                const newCareers = [...formData.careers, newCareer];
                setFormData({ ...formData, careers: newCareers });
                setCurrentCareerIndex(newCareers.length - 1);
            };

            const toggleCareerSelection = (careerName) => {
                const currentCareers = formData.careers[currentCareerIndex].carrera || '';
                let careersArray = currentCareers ? currentCareers.split(',').map(s => s.trim()).filter(s => s) : [];
                
                if (careersArray.includes(careerName)) {
                    careersArray = careersArray.filter(c => c !== careerName);
                } else {
                    careersArray.push(careerName);
                }
                updateCareerField('carrera', careersArray.join(', '));
            };

            const handleSave = async () => {
                if (!selectedInst) return;
                const cleanedCareers = formData.careers.filter((c, i) => i === 0 || (c.carrera && c.carrera.trim() !== ''));
                const first = cleanedCareers[0] || {};
                
                const newData = { 
                    // Guardar campos editables de institución
                    customName: formData.name,
                    customLogo: formData.logo,
                    customColor: customColor,
                    
                    ...formData, careers: cleanedCareers,
                    carrera: first.carrera || '', matricula: first.matricula || '', cuota: first.cuota || '', valorSemestre: first.valorSemestre || '',
                    lastUpdated: new Date().toISOString(), lastModifiedBy: user?.uid || 'anon',
                };
                if (formData.responsable) setLastUser(formData.responsable);
                
                // IMPORTANTE: Usar el nombre original como ID para no duplicar, pero guardar el customName dentro
                const updated = { ...competitorData, [selectedInst.name]: newData };
                setCompetitorData(updated);
                setDynamicColors(prev => ({...prev, [selectedInst.name]: customColor}));

                if (demoMode) localStorage.setItem('competitor_data_shared', JSON.stringify(updated));
                else await setDoc(doc(db, 'base_datos_compartida', selectedInst.name), newData, { merge: true }).catch((err) => {
                    setDemoMode(true); localStorage.setItem('competitor_data_shared', JSON.stringify(updated));
                    alert("Error nube. Guardado local.");
                });
                setIsEditing(false);
            };

            const handleCreate = async () => {
                if (!newInstData.name) return;
                const newData = { 
                    lastUpdated: new Date().toISOString(), customColor: newInstData.color, 
                    customLogo: newInstData.logo, isCustom: true, careers: [{ ...EMPTY_CAREER, id: Date.now() }]
                };
                const updated = { ...competitorData, [newInstData.name]: newData };
                setCompetitorData(updated);
                if (demoMode) localStorage.setItem('competitor_data_shared', JSON.stringify(updated));
                else await setDoc(doc(db, 'base_datos_compartida', newInstData.name), newData);
                setIsAddingNew(false); setNewInstData({ name: '', logo: '', color: '#ec4899' });
            };
            
            const updateCareerField = (field, value) => {
                let finalVal = value;
                if (['matricula', 'cuota', 'valorSemestre'].includes(field)) finalVal = formatCurrency(value);
                const newCareers = [...formData.careers];
                newCareers[currentCareerIndex] = { ...newCareers[currentCareerIndex], [field]: finalVal };
                setFormData({ ...formData, careers: newCareers });
            };
            const addNewCareer = () => {
                const newCareers = [...formData.careers, { ...EMPTY_CAREER, id: Date.now() }];
                setFormData({ ...formData, careers: newCareers });
                setCurrentCareerIndex(newCareers.length - 1);
            };
            const removeCareer = (e, index) => {
                e.stopPropagation();
                if (formData.careers.length === 1) return;
                const newCareers = formData.careers.filter((_, i) => i !== index);
                setFormData({ ...formData, careers: newCareers });
                setCurrentCareerIndex(0);
            };
            const addField = () => setFormData(p => ({...p, customFields: [...p.customFields, {label:'', value:''}]}));
            const updateField = (i, f, v) => { const u = [...formData.customFields]; u[i][f] = v; setFormData(p => ({...p, customFields: u})); };
            const removeField = (i) => setFormData(p => ({...p, customFields: p.customFields.filter((_, idx) => idx !== i)}));
            const formatDate = (iso) => iso ? new Date(iso).toLocaleString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Sin datos';
            const currentCareer = formData.careers[currentCareerIndex] || EMPTY_CAREER;
            const activeColor = customColor || dynamicColors[selectedInst?.name] || '#ec4899';
            
            const compareValues = (valA, valB) => {
                const a = parseCurrency(valA);
                const b = parseCurrency(valB);
                if (a === 0 || b === 0) return { text: '-', color: 'text-white/50' };
                const diff = a - b;
                const percent = ((Math.abs(diff) / b) * 100).toFixed(1);
                const isPositive = diff > 0;
                if (isPositive) return { text: `+$${formatCurrency(diff)} (+${percent}%)`, subtext: "Más caro", color: 'text-green-400', bg: 'bg-green-900/20 border-green-500/30' };
                else return { text: `-$${formatCurrency(Math.abs(diff))} (-${percent}%)`, subtext: "Más barato", color: 'text-red-400', bg: 'bg-red-900/20 border-red-500/30' };
            };

            const calculateSemesterTotal = (career) => {
                if (career.valorSemestre) return parseCurrency(career.valorSemestre);
                const c = parseCurrency(career.cuota);
                const q = parseFloat(career.cantidadCuotas) || 0;
                const m = parseCurrency(career.matricula);
                if (c > 0 && q > 0) return (c * q) + m;
                return 0;
            };

            return (
                <div className="min-h-screen w-full relative overflow-x-hidden text-white pb-20 font-sans">
                    <div className="fixed inset-0 z-0" style={{
                        backgroundImage: 'url("https://i.postimg.cc/6wfDzyN9/image.png")',
                        backgroundSize: 'cover', backgroundPosition: 'center', backgroundAttachment: 'fixed'
                    }}></div>
                    <div className="fixed inset-0 bg-black/50 z-0 pointer-events-none"></div>
                    
                    {connectionError && (
                        <div className="fixed top-0 left-0 w-full bg-red-600 text-white p-3 text-center z-50 font-bold text-sm flex items-center justify-center gap-2 shadow-lg animate-pulse cursor-pointer" onClick={() => window.location.reload()}>
                            <AlertTriangle size={20}/> {connectionError} (Click para reintentar)
                        </div>
                    )}

                    <div className="relative z-10 container mx-auto px-4 pt-12">
                        <div className="glass-panel rounded-3xl p-4 md:p-6 shadow-2xl mb-10 flex flex-col md:flex-row justify-between items-center">
                            <div className="flex items-center gap-5 mb-4 md:mb-0">
                                <div className="w-16 h-16 md:w-20 md:h-20 bg-white/10 rounded-2xl flex items-center justify-center border border-white/10 shadow-inner p-2">
                                    <img src="https://i.ibb.co/4nqvFQGM/logo.png" className="w-full h-full object-contain drop-shadow-md" alt="Logo Cervantes"/>
                                </div>
                                <div>
                                    <h1 className="text-3xl md:text-4xl font-black text-white uppercase tracking-tight leading-none drop-shadow-md">Benchmarking</h1>
                                    <p className="text-pink-400 font-bold text-xs md:text-sm tracking-[0.2em] uppercase mt-1">Competencia & Relevamiento</p>
                                </div>
                            </div>
                            <div className="mt-4 md:mt-0 flex flex-col items-end gap-2 w-full md:w-auto">
                                <div className="flex gap-2 items-center flex-wrap justify-end">
                                    <div className="relative">
                                        <select className="bg-black/40 text-white/80 text-xs px-3 py-2 rounded-xl border border-white/10 outline-none appearance-none pr-8 cursor-pointer hover:bg-white/10 transition" value={filterCareer} onChange={(e) => setFilterCareer(e.target.value)}>
                                            <option value="">Todas las Carreras</option>
                                            {CAREER_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                        </select>
                                        <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-white/50"><Filter size={12}/></div>
                                    </div>
                                    <button onClick={exportExcel} className="bg-green-600/80 hover:bg-green-600 text-white px-4 py-2 rounded-xl border border-green-500/50 flex items-center gap-2 transition font-bold text-xs uppercase shadow-lg"><Download size={16}/> Excel</button>
                                    <button onClick={() => window.location.reload()} className="bg-white/10 hover:bg-white/20 text-white p-2 rounded-xl border border-white/10 transition" title="Recargar Datos"><RefreshCw size={16}/></button>
                                </div>
                                <div className="bg-black/40 px-4 py-1 rounded-xl border border-white/5 flex items-center gap-2">
                                    <p className="text-[10px] text-white/40 uppercase tracking-widest">{filterCareer ? `Filtrado: ${displayedInstitutions.length}` : `Total: ${mergedInstitutions.length}`}</p>
                                    {demoMode ? <div className="flex items-center gap-1 text-red-400 text-[10px]"><CloudOff size={10}/> Local</div> : <div className="flex items-center gap-1 text-green-400 text-[10px]"><Users size={10}/> Online</div>}
                                </div>
                            </div>
                        </div>

                        <div className="shelf-container">
                            {displayedInstitutions.map((inst) => {
                                const data = competitorData[inst.name];
                                const hasData = data && data.lastUpdated;
                                // Usar nombre y logo custom si existen
                                const displayName = data?.customName || inst.name;
                                const displayLogo = data?.customLogo || inst.logo;
                                const color = data?.customColor || dynamicColors[inst.name] || inst.color;

                                return (
                                    <div key={inst.name} onClick={() => handleCardClick(inst)} 
                                         className="book-spine"
                                         style={{ 
                                             backgroundColor: color, 
                                             borderColor: `${color}80`
                                         }}>
                                        
                                        <div className="spine-content text-white">
                                            <div className="w-12 h-12 bg-white/20 rounded-full p-2 flex items-center justify-center shadow-inner">
                                                {displayLogo ? <img src={displayLogo} className="w-full h-full object-contain" /> : <School size={20}/>}
                                            </div>
                                            <span className="spine-title text-xl tracking-widest drop-shadow-md">{displayName.substring(0, 20)}</span>
                                            <div className="text-[10px] opacity-80 font-mono rotate-180 writing-vertical-rl font-bold">
                                                {hasData ? new Date(data.lastUpdated).getFullYear() : '---'}
                                            </div>
                                        </div>

                                        <div className="cover-content text-white" style={{ background: `linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.8))` }}>
                                            <div className="flex flex-col h-full items-center text-center relative z-10">
                                                
                                                <div className="w-32 h-32 mb-4 transition-transform duration-500 group-hover:scale-110 filter drop-shadow-2xl flex items-center justify-center">
                                                    {displayLogo ? <img src={displayLogo} className="max-w-full max-h-full object-contain" /> : <School className="text-white/50 w-20 h-20"/>}
                                                </div>
                                                
                                                <h3 className="text-2xl md:text-3xl font-black leading-tight mb-6 drop-shadow-lg uppercase tracking-tight">{displayName}</h3>
                                                
                                                <div className="w-full flex-1 overflow-y-auto custom-scrollbar mb-6 text-left pl-4 border-l-4 border-white/20">
                                                    {data?.careers && data.careers.length > 0 ? (
                                                        <div className="flex flex-col gap-3">
                                                            {data.careers.map((c, idx) => (
                                                                c.carrera && <span key={idx} className="text-sm font-bold text-white/90 block leading-snug border-b border-white/10 pb-1 shadow-black drop-shadow-sm">{c.carrera}</span>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <p className="text-sm text-white/60 italic">Sin datos cargados</p>
                                                    )}
                                                </div>
                                                
                                                {/* Marca de Agua */}
                                                {displayLogo && <img src={displayLogo} className="watermark-logo" />}

                                                <button 
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setCompareMode({ instName: inst.name, careerIdx: 0 });
                                                    }}
                                                    className="w-full bg-white/10 hover:bg-white/20 text-white text-sm font-bold uppercase tracking-widest py-3 rounded-xl mt-auto flex items-center justify-center gap-2 transition border border-white/10 relative z-20 backdrop-blur-sm"
                                                >
                                                    <Scale size={16}/> Comparar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            
                            <button onClick={() => setIsAddingNew(true)} className="book-spine bg-white/5 border-2 border-dashed border-white/20 flex flex-col items-center justify-center text-white/30 hover:text-white hover:border-white/50 transition-all">
                                <div className="hidden lg:block writing-vertical-rl text-orientation-mixed uppercase font-bold text-sm tracking-widest">Agregar Nueva</div>
                                <div className="lg:hidden uppercase font-bold text-sm tracking-widest mb-2">Agregar Nueva</div>
                                <Plus size={32} className="mt-4 lg:mt-0"/>
                            </button>
                        </div>
                    </div>

                    {/* ... MODALES ... */}
                    {compareMode && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
                            <div className="absolute inset-0 bg-black/95 backdrop-blur-xl" onClick={() => setCompareMode(null)}></div>
                            <div className="relative w-full max-w-4xl bg-[#111] rounded-3xl shadow-2xl border border-white/10 flex flex-col max-h-[90vh]">
                                <div className="p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
                                    <h3 className="text-xl font-bold flex items-center gap-2"><Scale className="text-pink-500"/> Comparador</h3>
                                    <button onClick={() => setCompareMode(null)}><X className="text-white/50 hover:text-white"/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 md:p-8">
                                    {(() => {
                                        const compInst = competitorData[compareMode.instName] || {};
                                        const compCareer = compInst.careers?.[compareMode.careerIdx] || {};
                                        const cvData = competitorData['Cervantes'] || {};
                                        const careerName = compCareer.carrera ? compCareer.carrera.split(',')[0] : '';
                                        let cvCareer = cvData.careers?.find(c => c.carrera?.includes(careerName)) || (cvData.careers?.length > 0 ? cvData.careers[0] : {});
                                        const compSem = calculateSemesterTotal(compCareer);
                                        const cvSem = cvCareer ? calculateSemesterTotal(cvCareer) : 0;
                                        const fields = [{ l: 'Matrícula', a: compCareer.matricula, b: cvCareer?.matricula }, { l: 'Cuota', a: compCareer.cuota, b: cvCareer?.cuota }, { l: 'Semestre Total', a: formatCurrency(compSem), b: formatCurrency(cvSem) }];
                                        
                                        return (
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                                <div className="bg-blue-900/20 p-4 rounded-2xl border border-blue-500/30 order-2 md:order-1">
                                                    <h4 className="text-blue-400 font-black text-lg mb-2">Cervantes</h4>
                                                    <div className="text-xs text-white/60 mb-4">{cvCareer.carrera || 'General'}</div>
                                                    {fields.map(f => <div key={f.l} className="mb-2"><p className="text-[10px] uppercase text-white/40">{f.l}</p><p className="text-md font-mono">{f.b ? `$${f.b}` : '-'}</p></div>)}
                                                </div>
                                                <div className="flex flex-row md:flex-col justify-center items-center gap-4 order-1 md:order-2 py-4">
                                                    {fields.map(f => { const c = compareValues(f.a, f.b); return (<div key={f.l} className={`text-xs font-bold ${c.color} bg-black/40 px-2 py-1 rounded-full border ${c.bg}`}>{c.text}</div>) })}
                                                </div>
                                                <div className="bg-white/5 p-4 rounded-2xl border border-white/10 order-3">
                                                    <h4 className="text-white font-black text-lg mb-2">{compInst.customName || compareMode.instName}</h4>
                                                    {compInst.careers?.length > 1 && <select className="bg-black/50 text-xs p-1 rounded mb-4 w-full" onChange={(e) => setCompareMode({...compareMode, careerIdx: e.target.value})} value={compareMode.careerIdx}>{compInst.careers.map((c, i) => <option key={i} value={i}>{c.carrera || `Opción ${i+1}`}</option>)}</select>}
                                                    <div className="text-xs text-white/60 mb-4">{compCareer.carrera || 'General'}</div>
                                                    {fields.map(f => <div key={f.l} className="mb-2"><p className="text-[10px] uppercase text-white/40">{f.l}</p><p className="text-md font-mono">{f.a ? `$${f.a}` : '-'}</p></div>)}
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>
                        </div>
                    )}

                    {selectedInst && !compareMode && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
                            <div className="absolute inset-0 bg-black/90 backdrop-blur-xl" onClick={() => setSelectedInst(null)}></div>
                            <div className="relative w-full max-w-6xl rounded-[2rem] shadow-2xl flex flex-col max-h-[95vh] overflow-hidden border-2 transition-all" style={{ backgroundColor: '#0a0a0a', borderColor: activeColor, boxShadow: `0 0 100px ${activeColor}40` }}>
                                <div className="absolute inset-0 pointer-events-none opacity-30" style={{ background: `linear-gradient(135deg, ${activeColor} 0%, transparent 100%)` }}></div>
                                <div className="relative p-6 md:p-8 border-b border-white/10 flex justify-between items-start backdrop-blur-sm z-10">
                                    <div className="flex gap-4 items-center">
                                        <div className="w-16 h-16 md:w-24 md:h-24 shrink-0 bg-white/5 rounded-2xl p-2 border border-white/10">{formData.logo ? <img src={formData.logo} className="w-full h-full object-contain" /> : <School className="text-white w-full h-full"/>}</div>
                                        <div>
                                            <h2 className="text-2xl md:text-4xl font-black text-white tracking-tight">{formData.name}</h2>
                                            <div className="flex gap-4 mt-2 text-white/60 text-xs flex-col md:flex-row">
                                                {isEditing ? (
                                                    <div className="grid grid-cols-2 gap-2 w-full">
                                                        <input placeholder="Nombre Institución" className="bg-white/10 rounded px-2 py-1 w-full outline-none font-bold text-white" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})}/>
                                                        <input placeholder="URL Logo" className="bg-white/10 rounded px-2 py-1 w-full outline-none" value={formData.logo} onChange={e => setFormData({...formData, logo: e.target.value})}/>
                                                        <input placeholder="Dirección..." className="bg-white/10 rounded px-2 py-1 w-full outline-none" value={formData.direccion} onChange={e => setFormData({...formData, direccion: e.target.value})}/>
                                                        <input placeholder="Contacto..." className="bg-white/10 rounded px-2 py-1 w-full outline-none" value={formData.contacto} onChange={e => setFormData({...formData, contacto: e.target.value})}/>
                                                    </div>
                                                ) : (
                                                    <>{formData.direccion && <span className="flex items-center gap-1"><MapPin size={12}/> {formData.direccion}</span>}{formData.contacto && <span className="flex items-center gap-1"><Phone size={12}/> {formData.contacto}</span>}</>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        {isEditing ? <div className="flex flex-col items-center gap-1"><label className="text-[8px] uppercase font-bold text-white/40">Color</label><input type="color" value={activeColor} onChange={(e) => setCustomColor(e.target.value)} /></div> : <div className="flex gap-2"><button onClick={() => setShowMagicPaste(!showMagicPaste)} className="p-2 bg-pink-600/20 rounded-full text-pink-200 border border-pink-500/50 magic-btn"><Sparkles size={18}/></button><button onClick={() => setIsEditing(true)} className="p-2 bg-white/10 rounded-full hover:bg-white/30 text-white border border-white/10"><Pencil size={18}/></button></div>}
                                        <button onClick={() => setSelectedInst(null)} className="p-2 bg-white/10 rounded-full hover:bg-red-500/20 text-white border border-white/10"><X size={18}/></button>
                                    </div>
                                </div>
                                
                                {/* TABS */}
                                <div className="relative z-10 px-6 pt-4 pb-0 flex items-center gap-2 overflow-x-auto custom-scrollbar border-b border-white/10 bg-black/20">
                                    {formData.careers.map((career, idx) => (
                                        <button key={idx} onClick={() => setCurrentCareerIndex(idx)} className={`px-4 py-3 text-xs md:text-sm font-bold rounded-t-xl transition-all flex items-center gap-2 border-t border-x whitespace-nowrap ${currentCareerIndex === idx ? 'bg-[#1a1a1a] text-white border-white/20 border-b-[#1a1a1a] translate-y-[1px]' : 'bg-white/5 text-white/40 border-transparent hover:bg-white/10 hover:text-white/70'}`}>
                                            <GraduationCap size={14}/> {career.carrera && career.carrera.length > 15 ? career.carrera.substring(0,15) + '...' : (career.carrera || `Conf ${idx + 1}`)}
                                            {isEditing && (<div className="flex gap-1 ml-2"><span onClick={(e) => handleDuplicateCareer(e, idx)} className="p-1 hover:bg-blue-500/50 rounded-full"><Copy size={10}/></span>{formData.careers.length > 1 && <span onClick={(e) => removeCareer(e, idx)} className="p-1 hover:bg-red-500/50 rounded-full"><X size={10}/></span>}</div>)}
                                        </button>
                                    ))}
                                    {isEditing && (<button onClick={addNewCareer} className="px-3 py-2 text-xs bg-green-600/20 text-green-400 rounded-lg mb-1 ml-2 flex items-center gap-1 whitespace-nowrap"><Plus size={12}/> Nueva</button>)}
                                </div>

                                {showMagicPaste && (
                                    <div className="absolute inset-x-0 top-0 z-50 bg-[#111] border-b border-pink-500/30 p-6 shadow-2xl animate-in slide-in-from-top-10">
                                        <h3 className="text-pink-400 font-bold flex items-center gap-2 mb-2"><Sparkles size={18}/> Pegado Inteligente</h3>
                                        <textarea className="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-sm text-white focus:border-pink-500 outline-none h-24" placeholder="Pega el texto aquí..." value={magicText} onChange={(e) => setMagicText(e.target.value)}/>
                                        <div className="flex justify-end gap-2 mt-3"><button onClick={() => setShowMagicPaste(false)} className="px-4 py-2 text-xs text-white/50 hover:text-white">Cancelar</button><button onClick={handleMagicPaste} className="px-4 py-2 bg-pink-600 hover:bg-pink-500 text-white text-xs font-bold rounded-lg shadow-lg">✨ Analizar</button></div>
                                    </div>
                                )}

                                <div className="relative flex-1 overflow-y-auto custom-scrollbar p-4 md:p-8 bg-[#1a1a1a] z-10">
                                    {!isEditing ? (
                                        <div className="space-y-8">
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 p-4 md:p-6 bg-white/5 rounded-2xl border border-white/10">
                                                <div><label className="text-xs uppercase font-bold text-white/50 flex items-center gap-2"><GraduationCap size={12}/> Carrera(s)</label><p className="text-lg md:text-xl font-bold text-white">{currentCareer.carrera || 'No especificada'}</p></div>
                                                <div><label className="text-xs uppercase font-bold text-white/50 flex items-center gap-2"><Clock size={12}/> Duración</label><p className="text-md md:text-lg text-white/90">{currentCareer.duracion || '-'}</p></div>
                                                 <div><label className="text-xs uppercase font-bold text-white/50 flex items-center gap-2"><Award size={12}/> Título</label><p className="text-md md:text-lg text-white/90">{currentCareer.titulo || '-'}</p></div>
                                            </div>
                                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                                <div className="space-y-4">
                                                    <h3 className="text-lg font-bold text-emerald-400 border-b border-white/10 pb-2">Costos</h3>
                                                    <div className="bg-black/20 p-4 rounded-xl space-y-2">
                                                        <div className="flex justify-between"><span className="text-white/60">Matrícula</span><span className="font-mono font-bold">{currentCareer.matricula || '-'}</span></div>
                                                        <div className="flex justify-between"><span className="text-white/60">Cuota</span><span className="font-mono font-bold">{currentCareer.cuota || '-'}</span></div>
                                                        <div className="flex justify-between"><span className="text-white/60">Cant. Cuotas</span><span className="font-mono">{currentCareer.cantidadCuotas || '-'}</span></div>
                                                        <div className="flex justify-between border-t border-white/10 pt-2"><span className="text-white/60">Semestre</span><span className="font-mono font-bold text-emerald-400">{currentCareer.valorSemestre || '-'}</span></div>
                                                    </div>
                                                </div>
                                                <div className="space-y-4">
                                                    <h3 className="text-lg font-bold text-blue-400 border-b border-white/10 pb-2">Comercial</h3>
                                                    <p className="text-sm text-white/80"><strong>Modalidad:</strong> {currentCareer.modalidad || '-'}</p>
                                                    <p className="text-sm text-white/80"><strong>Promos:</strong> {currentCareer.promocion || '-'}</p>
                                                    <p className="text-sm text-white/80"><strong>Pagos:</strong> {currentCareer.mediosPago || '-'}</p>
                                                </div>
                                                <div className="space-y-4">
                                                    <h3 className="text-lg font-bold text-yellow-400 border-b border-white/10 pb-2">Análisis</h3>
                                                    <div className="bg-emerald-900/20 p-2 rounded text-sm border border-emerald-500/20"><span className="text-emerald-400 font-bold text-xs">PROS:</span> {currentCareer.destacadoPositivo || '-'}</div>
                                                    <div className="bg-red-900/20 p-2 rounded text-sm border border-red-500/20"><span className="text-red-400 font-bold text-xs">CONTRAS:</span> {currentCareer.destacadoNegativo || '-'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                            <div className="space-y-4">
                                                <h4 className="text-pink-500 font-bold border-b border-white/10 pb-1">Datos Básicos</h4>
                                                <div className="space-y-2">
                                                    <label className="text-xs text-white/50">Carreras (Separar con coma para agrupar)</label>
                                                    <div className="flex gap-2"><select className="bg-white/5 border border-white/10 rounded p-2 w-full text-sm" onChange={(e) => {if(e.target.value) toggleCareerSelection(e.target.value); e.target.value="";}}><option value="">+ Agregar...</option>{CAREER_OPTIONS.map(c=><option key={c} value={c}>{c}</option>)}</select><input placeholder="O escribir..." className="bg-white/5 border border-white/10 rounded p-2 w-full text-sm" id="customCareerInput"/><button onClick={()=>{const v=document.getElementById('customCareerInput').value; if(v) {toggleCareerSelection(v); document.getElementById('customCareerInput').value="";}}} className="bg-white/10 px-3 rounded text-xs">+</button></div>
                                                    <div className="flex flex-wrap gap-1">{currentCareer.carrera?.split(', ').map((c,i)=><span key={i} className="bg-pink-900/30 text-pink-200 text-[10px] px-2 py-1 rounded border border-pink-500/30 flex items-center gap-1">{c} <X size={8} onClick={()=>toggleCareerSelection(c)} className="cursor-pointer"/></span>)}</div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div><label className="text-xs text-white/50">Matrícula ($)</label><input className="bg-white/5 border-white/10 rounded p-2 w-full" value={currentCareer.matricula} onChange={e=>updateCareerField('matricula', e.target.value)}/></div>
                                                    <div><label className="text-xs text-white/50">Cuota ($)</label><input className="bg-white/5 border-white/10 rounded p-2 w-full" value={currentCareer.cuota} onChange={e=>updateCareerField('cuota', e.target.value)}/></div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div><label className="text-xs text-white/50">Cant. Cuotas</label><input type="number" className="bg-white/5 border-white/10 rounded p-2 w-full" value={currentCareer.cantidadCuotas} onChange={e=>updateCareerField('cantidadCuotas', e.target.value)}/></div>
                                                    <div><label className="text-xs text-white/50">Semestre ($)</label><input className="bg-white/5 border-white/10 rounded p-2 w-full" value={currentCareer.valorSemestre} onChange={e=>updateCareerField('valorSemestre', e.target.value)}/></div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div><label className="text-xs text-white/50">Duración</label><input className="bg-white/5 border-white/10 rounded p-2 w-full" value={currentCareer.duracion} onChange={e=>updateCareerField('duracion', e.target.value)}/></div>
                                                    <div><label className="text-xs text-white/50">Título</label><input className="bg-white/5 border-white/10 rounded p-2 w-full" value={currentCareer.titulo} onChange={e=>updateCareerField('titulo', e.target.value)}/></div>
                                                </div>
                                            </div>
                                            <div className="space-y-4">
                                                <h4 className="text-blue-500 font-bold border-b border-white/10 pb-1">Detalles</h4>
                                                <textarea placeholder="Modalidad..." className="bg-white/5 border-white/10 rounded p-2 w-full h-10 text-sm" value={currentCareer.modalidad} onChange={e=>updateCareerField('modalidad', e.target.value)}/>
                                                <textarea placeholder="Promociones..." className="bg-white/5 border-white/10 rounded p-2 w-full h-16 text-sm" value={currentCareer.promocion} onChange={e=>updateCareerField('promocion', e.target.value)}/>
                                                <div className="pt-2"><label className="text-xs text-pink-500 font-bold">Tu Nombre</label><input className="bg-white/10 border-white/20 rounded p-2 w-full" value={formData.responsable} onChange={e=>setFormData({...formData, responsable:e.target.value})}/></div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Footer */}
                                <div className="p-4 border-t border-white/10 bg-[#0a0a0a] flex justify-between items-center z-10">
                                    <div className="text-xs text-white/30">Modificado por: {competitorData[selectedInst.name]?.responsable || '-'}</div>
                                    {isEditing && <div className="flex gap-3"><button onClick={() => setIsEditing(false)} className="px-4 py-2 rounded text-white/60 hover:bg-white/10">Cancelar</button><button onClick={handleSave} className="px-6 py-2 rounded bg-white text-black font-bold hover:scale-105 shadow-xl">GUARDAR</button></div>}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {isAddingNew && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 animate-in fade-in">
                            <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={() => setIsAddingNew(false)}></div>
                            <div className="relative w-full max-w-md bg-[#151515] border border-white/10 rounded-3xl p-8 shadow-2xl">
                                <h2 className="text-2xl font-bold text-white mb-4">Nueva Competencia</h2>
                                <div className="space-y-4">
                                    <input placeholder="Nombre" className="w-full bg-black/30 border border-white/10 rounded p-3 text-white" value={newInstData.name} onChange={e => setNewInstData({...newInstData, name: e.target.value})} />
                                    <input placeholder="URL Logo" className="w-full bg-black/30 border border-white/10 rounded p-3 text-white" value={newInstData.logo} onChange={e => setNewInstData({...newInstData, logo: e.target.value})} />
                                    <input type="color" className="w-full h-10 bg-transparent cursor-pointer" value={newInstData.color} onChange={e => setNewInstData({...newInstData, color: e.target.value})} />
                                </div>
                                <div className="flex justify-end gap-3 mt-6">
                                    <button onClick={() => setIsAddingNew(false)} className="px-4 py-2 text-white/60">Cancelar</button>
                                    <button onClick={handleCreate} className="px-6 py-2 bg-pink-600 text-white font-bold rounded">Crear</button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<CompetitorApp />);
    </script>
</body>
</html>
